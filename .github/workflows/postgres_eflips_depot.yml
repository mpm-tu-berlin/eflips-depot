## TODO:: Achtung, basiert evtl noch zu stark auf dem RLI Skript, ggf. copyright beachten?!


name: Automatic tests for eflips depot
on: pull_request
#  pull_request:
#    branches:
#      - feature/test-pytest-postgres-jc
env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.4.2"
  POETRY_URL: https://install.python-poetry.org

jobs:
  # Label
  Runner-job-of-Tests-with-DB:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgis/postgis
        env:
          POSTGRES_PASSWORD: postgres
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # Maps tcp port 5432 on service container to the host
          - 5432:5432

    steps:
      # Downloads a copy of the code in your repository before running CI tests
      - name: Check out code
        uses: actions/checkout@v3
      - name: Set Up Gdal
        run: |
          sudo apt-get update
          sudo apt-get install gdal-bin
          echo ogrinfo --version

      # TODO ben√∂tigen wir Django und Chrom?
      - name: setup-chromedriver
        uses: nanasess/setup-chromedriver@v2.2.0

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install Dependency
        run: |
          poetry install --no-root
      - name: Run Tests
        run:
          poetry run pytest #test
        env:
          DJANGO_SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_DEBUG: True
          # Replace with your own database info
          DATABASE_URL: postgis://postgres:postgres@localhost/DbName
          CELERY_USE: False
          CELERY_BROKER_URL: pyamqp://guerrst@localhost//
          TILING_SERVICE_TOKEN: ${{ secrets.TILING_SERVICE_TOKEN }}
          TILING_SERVICE_STYLE_ID: basic-v2
          DJANGO_SETTINGS_MODULE: ebusdjango.settings
          # The hostname used to communicate with the PostgreSQL service container
          POSTGRES_HOST: localhost
          # The default PostgreSQL port
          POSTGRES_PORT: 5432
